#!/bin/bash

set -e

# COLORS
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

HOME="$(git rev-parse --show-toplevel)"
OS=$(uname -s)

cleanup() {
    cd "$HOME"

    echo -e "${BLUE}–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤...${NC}"
    for PORT in 8080 8888 8001 8011 8022; do
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç: ${PORT}"
        if [[ "$OS" == "Linux" ]]; then
            # –î–ª—è Linux –∏—Å–ø–æ–ª—å–∑—É–µ–º netstat + grep –∏–ª–∏ ss
            PID=$(netstat -ano | grep ":$PORT" | awk '{print $(NF)}' | tail -n 1 | tr -d '\r')

            if [[ -z "$PID" ]]; then
                echo "‚úÖ –ü–æ—Ä—Ç $PORT —Å–≤–æ–±–æ–¥–µ–Ω!"
            else
                echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É $PORT —Å PID: $PID"
                echo "üî™ –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å..."
                kill -9 $PID
                echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å $PID –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            fi
        elif [[ "$OS" == "MINGW64_NT"* || "$OS" == "CYGWIN"* || "$OS" == "Windows_NT"* ]]; then
            # –î–ª—è Windows (Git Bash, Cygwin, MinGW)
            PID=$(netstat -ano | grep ":$PORT" | awk '{print $(NF)}' | tail -n 1 | tr -d '\r')

            if [[ -z "$PID" ]]; then
                echo "‚úÖ –ü–æ—Ä—Ç $PORT —Å–≤–æ–±–æ–¥–µ–Ω!"
            else
                echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É $PORT —Å PID: $PID"
                echo "üî™ –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å..."
                taskkill //F //PID "$PID" 2>/dev/null
                echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å $PID –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            fi
        else
            echo -e "${YELLOW}‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –û–°: $OS${NC}"
            exit 1
        fi
    done
}

cleanup
