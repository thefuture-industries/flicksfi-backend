user www-data;
worker_processes auto;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 768;
}

http {
    ##
    # Basic Settings
    ##
    sendfile on;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    client_header_timeout 10; # Таймаут для чтения заголовков запроса
    client_body_timeout 10; # Таймаут для чтения тела запроса
    send_timeout 10; # Таймаут для отправки ответа

    server_tokens off; # Скрываем версию Nginx
    add_header X-Frame-Options "SAMEORIGIN"; # Защита от Clickjacking
    add_header X-Content-Type-Options "nosniff"; # Защита от MIME-sniffing
    add_header X-XSS-Protection "1; mode=block"; # Включаем XSS фильтр браузера
    add_header Referrer-Policy "strict-origin-when-cross-origin"; # Управление Referrer

    ##
    # Gzip Settings
    ##
    gzip on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6; # Компромисс между сжатием и нагрузкой на CPU
    gzip_buffers 16 8k;

    limit_req_zone $binary_remote_addr zone=limits:10m rate=1r/s;
    limit_conn_zone $binary_remote_addr zone=connlimit:10m;

    ##
    # Virtual Host Configs
    ##
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}

stream {
    server {
        listen 12346;
        proxy_pass device_tcp;
    }

    server {
        listen 12347;
        proxy_pass configurator_tcp;
    }

    upstream device_tcp {
        server http://89.111.141.170:12346;
    }

    upstream configurator_tcp {
        server http://89.111.141.170:12347;
    }
}
