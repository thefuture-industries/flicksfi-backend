name: Preview Check

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest
        container:
            image: reactnativecommunity/react-native-android
        permissions:
            contents: read
            pull-requests: write
            issues: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install pnpm
              run: npm i -g pnpm

            - name: Install packages React Native
              run: |
                  pnpm install --dir ./client-mobile

            # Установка Java и Android SDK
            - name: Install Java and Android SDK
              uses: actions/setup-java@v3
              with:
                  distribution: 'temurin'
                  java-version: '17'

            # - name: Install Android SDK
            #   run: |
            #       sudo apt update
            #       sudo apt install -y android-sdk
            #       echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
            #       echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
            #       echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
            #       echo "$ANDROID_HOME/tools" >> $GITHUB_PATH

            - name: Install Expo CLI
              run: npm i -g expo-cli eas-cli

            - name: 🏗 Setup EAS
              uses: expo/expo-github-action@v8
              with:
                  eas-version: latest
                  token: ${{ secrets.EXPO_TOKEN }}

            # - name: Decode JKS KEY
            #   run: |
            #       cd ./client-mobile
            #       mkdir -p ./android/app
            #       echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > ./android/app/keystore.jks

            - name: Set enviroment variables
              run: |
                  echo "ANDROID_KEYSTORE_PATH=./client-mobile/android/app/keystore.jks" >> $GITHUB_ENV
                  echo "ANDROID_KEYSTORE_PASSWORD=password" >> $GITHUB_ENV
                  echo "ANDROID_KEY_ALIAS=my-key" >> $GITHUB_ENV
                  echo "ANDROID_KEY_PASSWORD=password" >> $GITHUB_ENV

            # - name: Build APK
            #   run: |
            #       cd ./client-mobile
            #       eas build --platform android --profile preview --non-interactive

            - name: Setup Golang Packages
              uses: actions/setup-go@v4
              with:
                  go-version: 1.23.0

            - name: Build Golang Gateway Server
              run: |
                  cd ./server/gateway-service
                  make build

            - name: Build Golang Gateway Server | test
              run: |
                  cd ./server/gateway-service
                  make build
                  cd ./test && go test -v

            # USER SERVICE
            - name: Install dependencies (user-service)
              working-directory: ./server/user-service
              run: |
                  go mod download

            - name: Run make (user-service) | test
              working-directory: ./server/user-service
              run: make build

            # MOVIE SERVICE
            - name: Install dependencies (movie-service)
              working-directory: ./server/movie-service
              run: |
                  go mod download

            - name: Run make (movie-service) | test
              working-directory: ./server/movie-service
              run: make build

            # Проверка свободного порта (Linux)
            - name: Check port -> 8080
              run: |
                  if lsof -i :8080; then
                    echo "Port 8080 exists!";
                    exit 1;
                  else
                    echo "Port 8080 is free!";
                  fi

            - name: Check port -> 8001
              run: |
                  if lsof -i :8001; then
                    echo "Port 8001 exists!";
                    exit 1;
                  else
                    echo "Port 8001 is free!";
                  fi

            - name: Check port -> 8011
              run: |
                  if lsof -i :8011; then
                    echo "Port 8011 exists!";
                    exit 1;
                  else
                    echo "Port 8011 is free!";
                  fi
